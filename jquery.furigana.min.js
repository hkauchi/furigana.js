/*!
 * Furigana.js is a jQuery plugin that supports the text input of
 * Japanese with furigana.
 * 
 * Furigana.js is released under the MIT License.
 * (c) 2012 Hisahiro Kauchi.
 */
(function(h){function k(m){return("\u4E00"<=m&&m<="\u9FBF")||m=="\u30F5"||m=="\u30F6"||m=="\u3005"}function l(m){return"\u30A1"<=m&&m<="\u30F4"}function b(m){return"\u3041"<=m&&m<="\u3094"}function f(m){return l(m)||b(m)}function c(m){return("\uFF21"<=m&&m<="\uFF3A")||("\uFF41"<=m&&m<="\uFF5A")}function a(p){var o="",q,n,m;for(n=0;n<p.length;n++){if(l(p.charAt(n))){o=p.substring(0,n);for(m=n;m<p.length;m++){q=p.charAt(m);if(l(q)){o+=String.fromCharCode(q.charCodeAt(0)-96)}else{o+=q}}return o}}return p}function j(p){var o="",q,n,m;for(n=0;n<p.length;n++){if(b(p.charAt(n))){o=p.substring(0,n);for(m=n;m<p.length;m++){q=p.charAt(m);if(b(q)){o+=String.fromCharCode(q.charCodeAt(0)+96)}else{o+=q}}return o}}return p}var i=function(n,m){this.kana=n;this.kanji=m||null;this.length=(m?m:n).length};i.prototype={html:function(){return this.kanji?"<ruby>"+this.kanji+"<rp>[</rp><rt>"+this.kana+"</rt><rp>]</rp></ruby>":this.kana}};var e=function(){this.init("","");this.parts=[];this.fixedParts=0};e.prototype={length:0,init:function(o,n){if(o==""&&n==""){this.parts=[];this.fixedParts=0;this.length=0;return}if(n==""){this.parts=[new i(o,"")];this.fixedParts=1;this.length=0;return}this.parts=[new i(o,n.charAt(0))];for(var m=1;m<n.length;m++){this.parts[m]=new i("",n.charAt(m))}this.fixedParts=n.length;this.length=n.length},add:function(v,x,z){var w=[],y,r,u,p=0;var t=false,q=false,s=false,o,m,A;this.parts.length=this.fixedParts;if(!x){this.parts.push(new i(v));if(!z){this.fixedParts++;this.length+=v.length}return this}A=v.charAt(v.length-1);m=x.charAt(x.length-1);if(c(A)){if(A!=m&&f(m)){p=1;if(c(v.charAt(v.length-2))){p++}v=v.substring(0,v.length-p)+m}else{if(A=="\uFF2E"||A=="\uFF4E"){v=v.substring(0,v.length-1)+"\u3093"}}}else{if(f(A)&&!k(m)&&!f(m)){v+=m}}p=0;for(r=0;r<x.length;r++){u=x.charAt(r);if(r==0){s=q=t=k(u.charAt(0));w[p]=u}else{if(t==k(u.charAt(0))){w[p]+=u}else{w[++p]=u;t=!t}}}o="";for(r=0;r<w.length;r++){if(w[r]=="\u30B1"&&r>0&&r<w.length-1){w[r-1]+=w[r]+w[r+1];w.splice(r,2);r--;continue}o+=s?"(.+)":"("+a(w[r])+")";s=!s}s=q;y=v.match(new RegExp("^"+o+"$"));if(!y){this.parts.push(new i(v,x));if(!z){this.fixedParts++;this.length+=x.length}return this}y.shift();for(r=0;r<w.length;r++){this.parts.push(s?new i(y[r],w[r]):new i(w[r]));if(!z){this.fixedParts++}s=!s}if(!z){this.length+=x.length}return this},removeLast:function(){var m=this.parts[this.fixedParts-1];this.length-=m.length;this.parts.length=--this.fixedParts},clear:function(){this.parts=[];this.length=0;this.fixedParts=0},kanji:function(){var n=[];for(var m=0;m<this.parts.length;m++){n[m]=this.parts[m].kanji||this.parts[m].kana}return n.join("")}};var d=function(m){this.kana=function(){var n,o=[],p=m.sentence.parts;for(n=0;n<p.length;n++){o[n]=p[n].kana}return o.join("")};this.hiragana=this.kana;this.katakana=function(){return j(this.kana())};this.html=function(){var n,o=[],p=m.sentence.parts;for(n=0;n<p.length;n++){o[n]=p[n].html()}return o.join("")},this.parts=function(){var n,q=[],o=m.sentence.parts;for(n=0;n<o.length;n++){q.push({kana:o[n].kana,kanji:o[n].kanji})}return q}};var g=function(m){this.textfield=m;this.fo=new d(this);this.callback=function(){};this.init()};g.prototype={init:function(){if(this.sentence){this.sentence.clear()}else{this.sentence=new e()}this.prev="";this.pending="";this.kana="";this.kanji="";this.kanjiFound=false;this.callback()},setCallback:function(n){var m=this;this.callback=function(){n.call(m.textfield,m.fo)};this.callback()},watch:function(){var m=this.textfield.value;if(m.length==0){this.init();return}if(m.length<this.sentence.length){this.sentence.removeLast();this.textfield.value=this.sentence.kanji();this.callback();this.prev="";this.pending="";return}this.pending=m.substring(this.sentence.length);if(this.pending!=this.prev){this.check();this.callback();this.prev=this.pending}},check:function(){if(this.kanjiFound){if(this.pending.indexOf(this.kanji)==0){this.sentence.add(this.kana,this.kanji);this.pending=this.pending.substring(this.kanji.length);if(this.pending){this.sentence.add(this.pending,null,true)}this.kana="";this.kanji="";this.prev="";this.kanjiFound=false}else{this.kanjiFound=this.hasKanji();this.kanji=this.pending;this.sentence.add(this.kana,this.kanji,true)}}else{this.kanjiFound=this.hasKanji();if(this.kanjiFound){this.kanji=this.pending;this.kana=a(this.prev);this.sentence.add(this.kana,this.kanji,true)}else{if(this.prev==this.pending){this.sentence.add(this.pending);this.kana="";this.kanji="";this.pending="";this.prev=""}else{this.sentence.add(this.pending,null,true)}}}},hasKanji:function(){for(var m=0;m<this.pending.length;m++){if(k(this.pending.charAt(m))){return true}}return false},fix:function(){this.pending=this.textfield.value.substring(this.sentence.length);this.check();this.callback()}};h.fn.furigana=function(){var s=null;var m=arguments;var p="";if(m.length==1){if(h.isFunction(m[0])){s=m[0]}}else{if(m.length==2){var n=m[0];var q=h(m[1]);if(q.length){var r=q[0];if(r.tagName=="INPUT"||r.tagName=="TEXTAREA"){p=a(q.val())}}s=function(o){var t=o[n]();q.each(function(){if(this.tagName=="INPUT"||this.tagName=="TEXTAREA"){this.value=t}else{this.innerHTML=t}})}}}this.each(function(){var u=new g(this);u.sentence.init(a(p),this.value);u.setCallback(s);var o=navigator.userAgent;if(o.match(/MSIE/)||o.match(/Trident/)||o.match(/Chrome/)||o.match(/Safari/)){var v=function(){setTimeout(function(){u.watch()},0)};h(this).keydown(function(w){if(w.which==13){u.fix()}else{v()}}).keyup(v).keypress(v).blur(function(){u.fix();v()})}else{var t=false,v=null;v=function(){u.watch();if(t){setTimeout(v,10)}};h(this).keydown(function(w){if(w.which==13){u.fix()}}).focus(function(w){t=true;setTimeout(v,0)}).blur(function(w){t=false})}});return this}})(jQuery);