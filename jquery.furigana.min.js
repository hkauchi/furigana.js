/*!
 * Furigana.js is a jQuery plugin that supports the text input of
 * Japanese with furigana.
 * 
 * Furigana.js is released under the MIT License.
 * (c) 2012 Hisahiro Kauchi.
 */
(function(h){function j(l){return("\u4E00"<=l&&l<="\u9FBF")||l=="\u30F5"||l=="\u30F6"||l=="\u3005"}function k(l){return"\u30A1"<=l&&l<="\u30F4"}function b(l){return"\u3041"<=l&&l<="\u3094"}function f(l){return k(l)||b(l)}function c(l){return("\uFF21"<=l&&l<="\uFF3A")||("\uFF41"<=l&&l<="\uFF5A")}function a(o){var n="",p,m,l;for(m=0;m<o.length;m++){if(k(o.charAt(m))){for(l=m;l<o.length;l++){p=o.charAt(l);if(k(p)){n+=String.fromCharCode(p.charCodeAt(0)-96)}else{n+=p}}return n}}return o}var i=function(m,l){this.kana=m;this.kanji=l||null;this.length=(l?l:m).length};i.prototype={html:function(){return this.kanji?"<ruby>"+this.kanji+"<rp>[</rp><rt>"+this.kana+"</rt><rp>]</rp></ruby>":this.kana}};var e=function(){this.parts=[];this.fixedParts=0};e.prototype={length:0,add:function(u,w,y){var v=[],x,q,t,o=0;var s=false,p=false,r=false,m,l,z;this.parts.length=this.fixedParts;if(!w){this.parts.push(new i(u));if(!y){this.fixedParts++;this.length+=u.length}return this}z=u.charAt(u.length-1);l=w.charAt(w.length-1);if(c(z)){if(z!=l&&f(l)){o=1;if(c(u.charAt(u.length-2))){o++}u=u.substring(0,u.length-o)+l}else{if(z=="\uFF2E"||z=="\uFF4E"){u=u.substring(0,u.length-1)+"\u3093"}}}else{if(f(z)&&!j(l)&&!f(l)){u+=l}}o=0;for(q=0;q<w.length;q++){t=w.charAt(q);if(q==0){r=p=s=j(t.charAt(0));v[o]=t}else{if(s==j(t.charAt(0))){v[o]+=t}else{v[++o]=t;s=!s}}}m="";for(q=0;q<v.length;q++){if(v[q]=="\u30B1"&&q>0&&q<v.length-1){v[q-1]+=v[q]+v[q+1];v.splice(q,2);q--;continue}m+=r?"(.+)":"("+a(v[q])+")";r=!r}r=p;x=u.match(new RegExp("^"+m+"$"));if(!x){this.parts.push(new i(u,w));if(!y){this.fixedParts++;this.length+=w.length}return this}x.shift();for(q=0;q<v.length;q++){this.parts.push(r?new i(x[q],v[q]):new i(v[q]));if(!y){this.fixedParts++}r=!r}if(!y){this.length+=w.length}return this},removeLast:function(){var l=this.parts[this.fixedParts-1];this.length-=l.length;this.parts.length=--this.fixedParts},clear:function(){this.parts=[];this.length=0;this.fixedParts=0},kanji:function(){var m=[];for(var l=0;l<this.parts.length;l++){m[l]=this.parts[l].kanji||this.parts[l].kana}return m.join("")}};var d=function(l){this.kana=function(){var m,n=[],o=l.sentence.parts;for(m=0;m<o.length;m++){n[m]=o[m].kana}return n.join("")};this.html=function(){var m,n=[],o=l.sentence.parts;for(m=0;m<o.length;m++){n[m]=o[m].html()}return n.join("")},this.parts=function(){var m,o=[],n=l.sentence.parts;for(m=0;m<n.length;m++){o.add({kana:n[m].kana,kanji:n[m].kanji})}return o}};var g=function(l){this.textfield=l;this.fo=new d(this);this.callback=function(){};this.init()};g.prototype={init:function(){if(this.sentence){this.sentence.clear()}else{this.sentence=new e()}this.prev="";this.pending="";this.kana="";this.kanji="";this.kanjiFound=false;this.callback()},setCallback:function(m){var l=this;this.callback=function(){m.call(l.textfield,l.fo)};this.callback()},watch:function(){var l=this.textfield.value;if(l.length==0){this.init();return}if(l.length<this.sentence.length){this.sentence.removeLast();this.textfield.value=this.sentence.kanji();this.callback();this.prev="";this.pending="";return}this.pending=l.substring(this.sentence.length);if(this.pending!=this.prev){this.check();this.callback();this.prev=this.pending}},check:function(){if(this.kanjiFound){if(this.pending.indexOf(this.kanji)==0){this.sentence.add(this.kana,this.kanji);this.pending=this.pending.substring(this.kanji.length);if(this.pending){this.sentence.add(this.pending,null,true)}this.kana="";this.kanji="";this.prev="";this.kanjiFound=false}else{this.kanjiFound=this.hasKanji();this.kanji=this.pending;this.sentence.add(this.kana,this.kanji,true)}}else{this.kanjiFound=this.hasKanji();if(this.kanjiFound){this.kanji=this.pending;this.kana=a(this.prev);this.sentence.add(this.kana,this.kanji,true)}else{if(this.prev==this.pending){this.sentence.add(this.pending);this.kana="";this.kanji="";this.pending="";this.prev=""}else{this.sentence.add(this.pending,null,true)}}}},hasKanji:function(){for(var l=0;l<this.pending.length;l++){if(j(this.pending.charAt(l))){return true}}return false},fix:function(){this.pending=this.textfield.value.substring(this.sentence.length);this.check();this.callback()}};h.fn.furigana=function(){var o=null;var l=arguments;if(l.length==1){if(h.isFunction(l[0])){o=l[0]}}else{if(l.length==2){var m=l[0];var n=l[1];o=function(p){var q=p[m]();h(n).each(function(){if(this.tagName=="INPUT"||this.tagName=="TEXTAREA"){this.value=q}else{this.innerHTML=q}})}}}this.each(function(){var q=new g(this);q.setCallback(o);if(h.browser.webkit||h.browser.msie){var r=function(){setTimeout(function(){q.watch()},0)};h(this).keydown(function(s){if(s.which==13){q.fix()}else{r()}}).keyup(r).keypress(r).blur(function(){q.fix();r()})}else{var p=false,r=null;r=function(){q.watch();if(p){setTimeout(r,10)}};h(this).keydown(function(s){if(s.which==13){q.fix()}}).focus(function(s){p=true;setTimeout(r,0)}).blur(function(s){p=false})}});return this}})(jQuery);